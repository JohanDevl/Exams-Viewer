<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Exams Viewer - Modular Test</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="stylesheet" href="styles.css" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <header class="header">
        <h1><i class="fas fa-graduation-cap"></i> Exams Viewer - Modular Test</h1>
        <p>
          Testing modular architecture - Storage Module
        </p>
      </header>

      <!-- Test Section -->
      <div class="test-section" style="background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 8px;">
        <h3>üß™ Modules Storage, Settings & Data Models Test</h3>
        <div id="test-results" style="margin: 10px 0;">
          <p><strong>Tests en cours...</strong></p>
        </div>
        
        <div class="test-buttons" style="margin: 15px 0;">
          <button id="testStorage" style="margin: 5px; padding: 10px 15px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
            üß™ Test Storage Functions
          </button>
          <button id="testCompression" style="margin: 5px; padding: 10px 15px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
            üóúÔ∏è Test Compression
          </button>
          <button id="testSettings" style="margin: 5px; padding: 10px 15px; background: #ff6b35; color: white; border: none; border-radius: 4px; cursor: pointer;">
            ‚öôÔ∏è Test Settings Module
          </button>
          <button id="testTheme" style="margin: 5px; padding: 10px 15px; background: #8e44ad; color: white; border: none; border-radius: 4px; cursor: pointer;">
            üé® Test Theme Toggle
          </button>
          <button id="testModels" style="margin: 5px; padding: 10px 15px; background: #20c997; color: white; border: none; border-radius: 4px; cursor: pointer;">
            üèóÔ∏è Test Data Models
          </button>
          <button id="testSession" style="margin: 5px; padding: 10px 15px; background: #fd7e14; color: white; border: none; border-radius: 4px; cursor: pointer;">
            üìù Test Session Management
          </button>
          <button id="testDevMode" style="margin: 5px; padding: 10px 15px; background: #6f42c1; color: white; border: none; border-radius: 4px; cursor: pointer;">
            üîß Test Dev Mode
          </button>
          <button id="clearTests" style="margin: 5px; padding: 10px 15px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
            üóëÔ∏è Clear Tests
          </button>
        </div>
      </div>

      <!-- Settings Test Panel -->
      <div class="settings-test-panel" style="background: #e9ecef; padding: 20px; margin: 20px 0; border-radius: 8px;">
        <h3>‚öôÔ∏è Settings Test Panel</h3>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 15px 0;">
          <div class="settings-column">
            <h4>Display Preferences</h4>
            <label style="display: block; margin: 5px 0;">
              <input type="checkbox" id="darkModeToggle" style="margin-right: 8px;">
              Dark Mode
            </label>
            <label style="display: block; margin: 5px 0;">
              <input type="checkbox" id="showDiscussionDefault" style="margin-right: 8px;">
              Show Discussion Default
            </label>
            <label style="display: block; margin: 5px 0;">
              <input type="checkbox" id="highlightDefault" style="margin-right: 8px;">
              Highlight Default
            </label>
            <label style="display: block; margin: 5px 0;">
              <input type="checkbox" id="showTooltips" style="margin-right: 8px;">
              Show Tooltips
            </label>
          </div>
          
          <div class="settings-column">
            <h4>Interface Options</h4>
            <label style="display: block; margin: 5px 0;">
              <input type="checkbox" id="showQuestionToolbar" style="margin-right: 8px;">
              Show Question Toolbar
            </label>
            <label style="display: block; margin: 5px 0;">
              <input type="checkbox" id="showAdvancedSearch" style="margin-right: 8px;">
              Show Advanced Search
            </label>
            <label style="display: block; margin: 5px 0;">
              <input type="checkbox" id="showMainProgressBar" style="margin-right: 8px;" checked>
              Show Main Progress Bar
            </label>
            <label style="display: block; margin: 5px 0;">
              <input type="checkbox" id="enableLazyLoading" style="margin-right: 8px;">
              Enable Lazy Loading
            </label>
            <label style="display: block; margin: 5px 0;">
              <input type="checkbox" id="enableResumePosition" style="margin-right: 8px;">
              Enable Resume Position
            </label>
            <label style="display: block; margin: 5px 0;">
              <input type="checkbox" id="autoSavePosition" style="margin-right: 8px;">
              Auto Save Position
            </label>
          </div>
        </div>
        
        <div style="margin: 15px 0;">
          <button id="saveSettingsTest" style="padding: 10px 20px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
            üíæ Save Settings
          </button>
          <button id="loadSettingsTest" style="padding: 10px 20px; background: #ffc107; color: black; border: none; border-radius: 4px; cursor: pointer;">
            üìÇ Load Settings
          </button>
        </div>
      </div>

      <!-- Console Log Display -->
      <div id="console-log" style="background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; margin: 20px 0;">
        <strong style="color: #68d391;">Console Output:</strong><br>
        <div id="log-content"></div>
      </div>
    </div>

    <!-- Global Variables (minimal for testing) -->
    <script>
      // Global variables required by storage module
      let settings = {
        showDiscussionDefault: false,
        highlightDefault: false,
        darkMode: false,
        showQuestionToolbar: false,
        showAdvancedSearch: false,
        sidebarOpen: false,
        enableLazyLoading: false,
        showMainProgressBar: true,
        showTooltips: false,
        enableResumePosition: false,
        autoSavePosition: false,
      };

      let favoritesData = {
        favorites: {},
        categories: ["Important", "Review", "Difficult"],
        customCategories: [],
        isRevisionMode: false,
        revisionFilter: {
          showFavorites: true,
          showCategories: [],
          showNotes: true,
        },
      };

      let statistics = {
        sessions: [],
        currentSession: null,
        totalStats: {
          totalQuestions: 0,
          totalCorrect: 0,
          totalIncorrect: 0,
          totalPreview: 0,
          totalTime: 0,
          examStats: {},
        },
      };

      let resumePositions = {};
      let currentQuestions = [];
      let currentExam = { exam_name: "Test Exam" };

      // Mock functions required by storage module
      function showError(message) {
        addToLog(`‚ùå ERROR: ${message}`, 'error');
      }

      function showSuccess(message) {
        addToLog(`‚úÖ SUCCESS: ${message}`, 'success');
      }

      function applyTheme() {
        addToLog("üé® Theme applied", 'info');
      }

      function updateToolbarVisibility() {
        addToLog("üîß Toolbar visibility updated", 'info');
      }

      function updateTooltipVisibility() {
        addToLog("üí¨ Tooltip visibility updated", 'info');
      }

      function recalculateTotalStats() {
        addToLog("üìä Total stats recalculated", 'info');
      }

      function cleanCorruptedStatistics() {
        addToLog("üßπ Corrupted statistics cleaned", 'info');
      }

      function cleanupObsoleteData() {
        addToLog("üßπ Obsolete data cleaned", 'info');
      }

      // Console logging system
      function addToLog(message, type = 'log') {
        const logContent = document.getElementById('log-content');
        const timestamp = new Date().toLocaleTimeString();
        const colors = {
          log: '#e2e8f0',
          error: '#fc8181',
          success: '#68d391',
          info: '#63b3ed'
        };
        
        logContent.innerHTML += `<div style="color: ${colors[type]}; margin: 2px 0;">[${timestamp}] ${message}</div>`;
        logContent.scrollTop = logContent.scrollHeight;
      }

      // Override console methods to capture output
      const originalLog = console.log;
      const originalError = console.error;
      
      console.log = function(...args) {
        addToLog(args.join(' '), 'log');
        originalLog.apply(console, args);
      };
      
      console.error = function(...args) {
        addToLog(args.join(' '), 'error');
        originalError.apply(console, args);
      };
    </script>

    <!-- Load modular script -->
    <script type="module">
      import {
        isDevelopmentMode,
        devLog,
        devError,
        clearCorruptedData,
        saveStatistics,
        loadStatistics,
        saveFavorites,
        loadFavorites,
        loadSettings,
        saveSettings,
        loadResumePositions,
        saveResumePositions,
        saveResumePosition,
        getResumePosition,
        clearResumePosition,
      } from './js/modules/storage.js';

      // Also import settings module
      import {
        applyTheme,
        loadSettingsUI,
        saveSettingsUI,
        updateMainProgressBarVisibility,
        updateToolbarVisibility,
        updateTooltipVisibility,
        updateAdvancedSearchVisibility,
        setupSettingsEventListeners,
        initializeSettings,
      } from './js/modules/settings.js';

      // Also import data models module
      import {
        ExamSession,
        QuestionAttempt,
        compressData,
        decompressData,
        startExamSession,
        endCurrentSession,
        trackQuestionAttempt,
        trackQuestionVisit,
      } from './js/core/models.js';

      addToLog("üì¶ Storage module imported successfully!", 'success');
      addToLog("‚öôÔ∏è Settings module imported successfully!", 'success');
      addToLog("üèóÔ∏è Data Models module imported successfully!", 'success');

      // Make settings functions available globally for testing
      window.applyTheme = applyTheme;
      window.loadSettingsUI = loadSettingsUI;
      window.saveSettingsUI = saveSettingsUI;
      window.updateMainProgressBarVisibility = updateMainProgressBarVisibility;
      window.updateToolbarVisibility = updateToolbarVisibility;
      window.updateTooltipVisibility = updateTooltipVisibility;
      window.updateAdvancedSearchVisibility = updateAdvancedSearchVisibility;
      window.setupSettingsEventListeners = setupSettingsEventListeners;
      window.initializeSettings = initializeSettings;

      // Make data models functions available globally for testing
      window.ExamSession = ExamSession;
      window.QuestionAttempt = QuestionAttempt;
      window.compressData = compressData;
      window.decompressData = decompressData;
      window.startExamSession = startExamSession;
      window.endCurrentSession = endCurrentSession;
      window.trackQuestionAttempt = trackQuestionAttempt;
      window.trackQuestionVisit = trackQuestionVisit;

      // Initialize settings module
      initializeSettings();

      // Test functions
      window.testStorage = function() {
        addToLog("üß™ Testing Storage Functions...", 'info');
        
        // Test statistics
        statistics.totalStats.totalQuestions = 42;
        saveStatistics();
        addToLog("‚úÖ Statistics saved", 'success');
        
        statistics.totalStats.totalQuestions = 0; // Reset
        loadStatistics();
        addToLog(`üìä Statistics loaded - totalQuestions: ${statistics.totalStats.totalQuestions}`, 'info');
        
        // Test favorites
        favoritesData.favorites['TEST'] = { 1: { isFavorite: true, note: 'Test note' } };
        saveFavorites();
        addToLog("‚≠ê Favorites saved", 'success');
        
        favoritesData.favorites = {}; // Reset
        loadFavorites();
        const testFav = favoritesData.favorites['TEST'];
        addToLog(`‚≠ê Favorites loaded - TEST exam has ${Object.keys(testFav || {}).length} items`, 'info');
        
        // Test resume positions
        saveResumePosition('TEST-EXAM', 5);
        addToLog("üìç Resume position saved", 'success');
        
        const position = getResumePosition('TEST-EXAM');
        addToLog(`üìç Resume position loaded - question ${position?.questionNumber || 'none'}`, 'info');
      };

      window.testCompression = function() {
        addToLog("üóúÔ∏è Testing Compression...", 'info');
        
        const testData = {
          sessions: [
            { examCode: 'TEST', examName: 'Test Exam', totalQuestions: 100 }
          ],
          totalStats: { totalQuestions: 50, totalCorrect: 30 }
        };
        
        const compressed = compressData(testData);
        addToLog(`üì¶ Original size: ${JSON.stringify(testData).length} chars`, 'info');
        addToLog(`üì¶ Compressed size: ${compressed.length} chars`, 'info');
        
        const decompressed = decompressData(compressed);
        const matches = JSON.stringify(testData) === JSON.stringify(decompressed);
        addToLog(`üîÑ Compression/Decompression: ${matches ? '‚úÖ SUCCESS' : '‚ùå FAILED'}`, matches ? 'success' : 'error');
      };

      window.testDevMode = function() {
        addToLog("üîß Testing Development Mode...", 'info');
        
        const isDevMode = isDevelopmentMode();
        addToLog(`üîß Development mode: ${isDevMode ? '‚úÖ ENABLED' : '‚ùå DISABLED'}`, isDevMode ? 'success' : 'info');
        
        devLog("This is a dev log message");
        devError("This is a dev error message");
      };

      // Test settings module
      window.testSettings = function() {
        addToLog("‚öôÔ∏è Testing Settings Module...", 'info');
        
        // Test settings load/save
        addToLog("üíæ Testing settings save/load cycle", 'info');
        
        // Modify a setting
        const darkModeToggle = document.getElementById('darkModeToggle');
        const originalState = darkModeToggle.checked;
        darkModeToggle.checked = !originalState;
        
        // Save settings
        saveSettingsUI();
        addToLog(`‚úÖ Settings saved - darkMode: ${darkModeToggle.checked}`, 'success');
        
        // Reset and reload
        darkModeToggle.checked = originalState;
        loadSettingsUI();
        addToLog(`üìÇ Settings loaded - darkMode: ${darkModeToggle.checked}`, 'info');
        
        // Test UI visibility functions
        addToLog("üîß Testing UI visibility functions", 'info');
        updateMainProgressBarVisibility();
        updateToolbarVisibility();
        updateTooltipVisibility();
        updateAdvancedSearchVisibility();
        addToLog("‚úÖ UI visibility functions executed", 'success');
      };

      // Test theme toggling
      window.testTheme = function() {
        addToLog("üé® Testing Theme Toggle...", 'info');
        
        const currentTheme = document.body.classList.contains('dark-mode');
        addToLog(`üé® Current theme: ${currentTheme ? 'Dark' : 'Light'}`, 'info');
        
        // Toggle theme
        applyTheme(!currentTheme);
        const newTheme = document.body.classList.contains('dark-mode');
        addToLog(`üé® New theme: ${newTheme ? 'Dark' : 'Light'}`, newTheme !== currentTheme ? 'success' : 'error');
        
        // Toggle back
        setTimeout(() => {
          applyTheme(currentTheme);
          addToLog(`üîÑ Reverted to original theme: ${currentTheme ? 'Dark' : 'Light'}`, 'info');
        }, 1000);
      };

      // Test data models
      window.testModels = function() {
        addToLog("üèóÔ∏è Testing Data Models...", 'info');
        
        // Test ExamSession class
        addToLog("üìù Testing ExamSession class", 'info');
        const session = new ExamSession('TEST-EXAM', 'Test Exam Name');
        addToLog(`‚úÖ Session created - ID: ${session.id}, Code: ${session.examCode}`, 'success');
        
        // Test QuestionAttempt class
        addToLog("‚ùì Testing QuestionAttempt class", 'info');
        const attempt = new QuestionAttempt(1, ['A', 'B']);
        attempt.addAttempt(['A'], false, 10, false);
        attempt.addAttempt(['A', 'B'], true, 15, true);
        addToLog(`‚úÖ Question attempt created - Final score: ${attempt.finalScore}%`, 'success');
        addToLog(`üìä Attempts: ${attempt.attempts.length}, Time: ${attempt.timeSpent}s`, 'info');
        
        // Test compression/decompression
        addToLog("üóúÔ∏è Testing compression with model data", 'info');
        const testData = {
          sessions: [session],
          currentSession: session,
          totalStats: { totalQuestions: 10, totalCorrect: 7 }
        };
        
        const compressed = compressData(testData);
        const decompressed = decompressData(compressed);
        const matches = JSON.stringify(testData).length === JSON.stringify(decompressed).length;
        addToLog(`üîÑ Model compression test: ${matches ? '‚úÖ SUCCESS' : '‚ùå FAILED'}`, matches ? 'success' : 'error');
        addToLog(`üì¶ Compression ratio: ${(compressed.length / JSON.stringify(testData).length * 100).toFixed(1)}%`, 'info');
      };

      // Test session management
      window.testSession = function() {
        addToLog("üìù Testing Session Management...", 'info');
        
        // Initialize statistics if not exists
        if (!statistics.sessions) {
          statistics.sessions = [];
        }
        
        // Start a new session
        addToLog("üöÄ Starting new exam session", 'info');
        const session = startExamSession('TEST-EXAM-2', 'Test Exam Session');
        addToLog(`‚úÖ Session started - ID: ${session?.id || 'N/A'}`, session ? 'success' : 'error');
        
        // Track some question visits
        addToLog("üëÄ Tracking question visits", 'info');
        trackQuestionVisit(1);
        trackQuestionVisit(2);
        trackQuestionVisit(3);
        addToLog(`üìä Visited questions: ${statistics.currentSession?.visitedQuestions?.length || 0}`, 'info');
        
        // Track question attempts
        addToLog("‚ùì Tracking question attempts", 'info');
        trackQuestionAttempt(1, ['A'], ['A', 'B'], false, 10);
        trackQuestionAttempt(1, ['A', 'B'], ['A', 'B'], true, 15);
        addToLog(`‚úÖ Question attempts tracked`, 'success');
        
        // End session
        addToLog("üèÅ Ending current session", 'info');
        const endedSession = endCurrentSession();
        addToLog(`‚úÖ Session ended - Total time: ${endedSession?.totalTime || 0}s`, 'success');
        addToLog(`üìä Total sessions: ${statistics.sessions?.length || 0}`, 'info');
      };

      window.clearTests = function() {
        document.getElementById('log-content').innerHTML = '';
        addToLog("üóëÔ∏è Test logs cleared", 'info');
        
        // Clear localStorage test data
        localStorage.removeItem('examViewerStatistics');
        localStorage.removeItem('examViewerFavorites');
        localStorage.removeItem('examViewerResumePositions');
        addToLog("üóëÔ∏è Test localStorage data cleared", 'info');
      };

      // Setup test event listeners
      document.getElementById('testStorage').addEventListener('click', testStorage);
      document.getElementById('testCompression').addEventListener('click', testCompression);
      document.getElementById('testSettings').addEventListener('click', testSettings);
      document.getElementById('testTheme').addEventListener('click', testTheme);
      document.getElementById('testModels').addEventListener('click', testModels);
      document.getElementById('testSession').addEventListener('click', testSession);
      document.getElementById('testDevMode').addEventListener('click', testDevMode);
      document.getElementById('clearTests').addEventListener('click', clearTests);
      
      // Setup settings test panel event listeners
      document.getElementById('saveSettingsTest').addEventListener('click', () => {
        saveSettingsUI();
        addToLog("üíæ Settings manually saved from test panel", 'success');
      });
      
      document.getElementById('loadSettingsTest').addEventListener('click', () => {
        loadSettingsUI();
        addToLog("üìÇ Settings manually loaded from test panel", 'success');
      });

      addToLog("üöÄ Modular test environment ready!", 'success');
      addToLog("Click buttons above to test Storage, Settings & Data Models modules functionality", 'info');
    </script>
  </body>
</html>