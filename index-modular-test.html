<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Exams Viewer - Modular Test</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="stylesheet" href="styles.css" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    
    <!-- Mobile Navigation Styles -->
    <style>
      .swipe-indicator {
        position: fixed;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0, 123, 255, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: bold;
        z-index: 9999;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
      }
      
      .swipe-indicator.left {
        left: 20px;
      }
      
      .swipe-indicator.right {
        right: 20px;
      }
      
      .swipe-indicator.show {
        opacity: 1;
      }
      
      .mobile-nav-bottom {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--bg-color, white);
        border-top: 1px solid var(--border-color, #ddd);
        display: flex;
        justify-content: space-around;
        padding: 8px;
        z-index: 1000;
        box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
      }
      
      .mobile-nav-bottom .nav-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 8px 12px;
        background: none;
        border: none;
        cursor: pointer;
        min-height: 44px;
        min-width: 44px;
        border-radius: 6px;
        transition: background-color 0.2s;
      }
      
      .mobile-nav-bottom .nav-btn:hover {
        background: var(--hover-color, #f5f5f5);
      }
      
      .mobile-nav-bottom .nav-btn i {
        font-size: 16px;
        margin-bottom: 2px;
      }
      
      .mobile-nav-bottom .nav-btn span {
        font-size: 11px;
        font-weight: 500;
      }
      
      .touch-feedback {
        transition: transform 0.1s;
      }
      
      .touch-feedback:active {
        transform: scale(0.95);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <header class="header">
        <h1><i class="fas fa-graduation-cap"></i> Exams Viewer - Modular Test</h1>
        <p>
          Testing modular architecture - Storage Module
        </p>
      </header>

      <!-- Test Section -->
      <div class="test-section" style="background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 8px;">
        <h3>🧪 Modules Storage, Settings, Data Models & UI Effects Test</h3>
        <div id="test-results" style="margin: 10px 0;">
          <p><strong>Tests en cours...</strong></p>
        </div>
        
        <div class="test-buttons" style="margin: 15px 0;">
          <button id="testStorage" style="margin: 5px; padding: 10px 15px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
            🧪 Test Storage Functions
          </button>
          <button id="testCompression" style="margin: 5px; padding: 10px 15px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
            🗜️ Test Compression
          </button>
          <button id="testSettings" style="margin: 5px; padding: 10px 15px; background: #ff6b35; color: white; border: none; border-radius: 4px; cursor: pointer;">
            ⚙️ Test Settings Module
          </button>
          <button id="testTheme" style="margin: 5px; padding: 10px 15px; background: #8e44ad; color: white; border: none; border-radius: 4px; cursor: pointer;">
            🎨 Test Theme Toggle
          </button>
          <button id="testModels" style="margin: 5px; padding: 10px 15px; background: #20c997; color: white; border: none; border-radius: 4px; cursor: pointer;">
            🏗️ Test Data Models
          </button>
          <button id="testSession" style="margin: 5px; padding: 10px 15px; background: #fd7e14; color: white; border: none; border-radius: 4px; cursor: pointer;">
            📝 Test Session Management
          </button>
          <button id="testUIEffects" style="margin: 5px; padding: 10px 15px; background: #e83e8c; color: white; border: none; border-radius: 4px; cursor: pointer;">
            🎨 Test UI Effects
          </button>
          <button id="testModals" style="margin: 5px; padding: 10px 15px; background: #6610f2; color: white; border: none; border-radius: 4px; cursor: pointer;">
            📱 Test Modals
          </button>
          <button id="testStatistics" style="margin: 5px; padding: 10px 15px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;">
            📊 Test Statistics
          </button>
          <button id="testFavorites" style="margin: 5px; padding: 10px 15px; background: #ffc107; color: black; border: none; border-radius: 4px; cursor: pointer;">
            ⭐ Test Favorites
          </button>
          <button id="testSearch" style="margin: 5px; padding: 10px 15px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
            🔍 Test Search
          </button>
          <button id="testResume" style="margin: 5px; padding: 10px 15px; background: #6f42c1; color: white; border: none; border-radius: 4px; cursor: pointer;">
            📍 Test Resume
          </button>
          <button id="testMobile" style="margin: 5px; padding: 10px 15px; background: #ff6b35; color: white; border: none; border-radius: 4px; cursor: pointer;">
            📱 Test Mobile Nav
          </button>
          <button id="testEnhanced" style="margin: 5px; padding: 10px 15px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;">
            🧭 Test Enhanced Nav
          </button>
          <button id="testDevMode" style="margin: 5px; padding: 10px 15px; background: #6f42c1; color: white; border: none; border-radius: 4px; cursor: pointer;">
            🔧 Test Dev Mode
          </button>
          <button id="clearTests" style="margin: 5px; padding: 10px 15px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
            🗑️ Clear Tests
          </button>
        </div>
      </div>

      <!-- Settings Test Panel -->
      <div class="settings-test-panel" style="background: #e9ecef; padding: 20px; margin: 20px 0; border-radius: 8px;">
        <h3>⚙️ Settings Test Panel</h3>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 15px 0;">
          <div class="settings-column">
            <h4>Display Preferences</h4>
            <label style="display: block; margin: 5px 0;">
              <input type="checkbox" id="darkModeToggle" style="margin-right: 8px;">
              Dark Mode
            </label>
            <label style="display: block; margin: 5px 0;">
              <input type="checkbox" id="showDiscussionDefault" style="margin-right: 8px;">
              Show Discussion Default
            </label>
            <label style="display: block; margin: 5px 0;">
              <input type="checkbox" id="highlightDefault" style="margin-right: 8px;">
              Highlight Default
            </label>
            <label style="display: block; margin: 5px 0;">
              <input type="checkbox" id="showTooltips" style="margin-right: 8px;">
              Show Tooltips
            </label>
          </div>
          
          <div class="settings-column">
            <h4>Interface Options</h4>
            <label style="display: block; margin: 5px 0;">
              <input type="checkbox" id="showQuestionToolbar" style="margin-right: 8px;">
              Show Question Toolbar
            </label>
            <label style="display: block; margin: 5px 0;">
              <input type="checkbox" id="showAdvancedSearch" style="margin-right: 8px;">
              Show Advanced Search
            </label>
            <label style="display: block; margin: 5px 0;">
              <input type="checkbox" id="showMainProgressBar" style="margin-right: 8px;" checked>
              Show Main Progress Bar
            </label>
            <label style="display: block; margin: 5px 0;">
              <input type="checkbox" id="enableLazyLoading" style="margin-right: 8px;">
              Enable Lazy Loading
            </label>
            <label style="display: block; margin: 5px 0;">
              <input type="checkbox" id="enableResumePosition" style="margin-right: 8px;">
              Enable Resume Position
            </label>
            <label style="display: block; margin: 5px 0;">
              <input type="checkbox" id="autoSavePosition" style="margin-right: 8px;">
              Auto Save Position
            </label>
          </div>
        </div>
        
        <div style="margin: 15px 0;">
          <button id="saveSettingsTest" style="padding: 10px 20px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
            💾 Save Settings
          </button>
          <button id="loadSettingsTest" style="padding: 10px 20px; background: #ffc107; color: black; border: none; border-radius: 4px; cursor: pointer;">
            📂 Load Settings
          </button>
        </div>
      </div>

      <!-- UI Elements for Testing -->
      <div id="loadingSection" style="display: none; background: #007bff; color: white; padding: 10px; text-align: center; margin: 20px 0; border-radius: 4px;">
        ⏳ Loading...
      </div>
      
      <div id="errorMessage" style="display: none; background: #dc3545; color: white; padding: 10px; margin: 20px 0; border-radius: 4px;">
        Error message will appear here
      </div>
      
      <div id="successMessage" style="display: none; background: #28a745; color: white; padding: 10px; margin: 20px 0; border-radius: 4px;">
        Success message will appear here
      </div>

      <div id="legal-info" style="display: none; background: #f8f9fa; padding: 15px; margin: 20px 0; border-radius: 4px; border: 1px solid #dee2e6;">
        <h4>Legal Information Test</h4>
        <p>This is a test of the legal info toggle functionality. It should show/hide when the toggle function is called.</p>
      </div>

      <!-- Console Log Display -->
      <div id="console-log" style="background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; margin: 20px 0;">
        <strong style="color: #68d391;">Console Output:</strong><br>
        <div id="log-content"></div>
      </div>
    </div>

    <!-- Global Variables (minimal for testing) -->
    <script>
      // Global variables required by storage module
      let settings = {
        showDiscussionDefault: false,
        highlightDefault: false,
        darkMode: false,
        showQuestionToolbar: false,
        showAdvancedSearch: false,
        sidebarOpen: false,
        enableLazyLoading: false,
        showMainProgressBar: true,
        showTooltips: false,
        enableResumePosition: false,
        autoSavePosition: false,
      };

      let favoritesData = {
        favorites: {},
        categories: ["Important", "Review", "Difficult"],
        customCategories: [],
        isRevisionMode: false,
        revisionFilter: {
          showFavorites: true,
          showCategories: [],
          showNotes: true,
        },
      };

      let statistics = {
        sessions: [],
        currentSession: null,
        totalStats: {
          totalQuestions: 0,
          totalCorrect: 0,
          totalIncorrect: 0,
          totalPreview: 0,
          totalTime: 0,
          examStats: {},
        },
      };

      let resumePositions = {};
      let currentQuestions = [];
      let currentExam = { exam_name: "Test Exam" };

      // Mock functions required by storage module
      function showError(message) {
        addToLog(`❌ ERROR: ${message}`, 'error');
      }

      function showSuccess(message) {
        addToLog(`✅ SUCCESS: ${message}`, 'success');
      }

      function applyTheme() {
        addToLog("🎨 Theme applied", 'info');
      }

      function updateToolbarVisibility() {
        addToLog("🔧 Toolbar visibility updated", 'info');
      }

      function updateTooltipVisibility() {
        addToLog("💬 Tooltip visibility updated", 'info');
      }

      function recalculateTotalStats() {
        addToLog("📊 Total stats recalculated", 'info');
      }

      function cleanCorruptedStatistics() {
        addToLog("🧹 Corrupted statistics cleaned", 'info');
      }

      function cleanupObsoleteData() {
        addToLog("🧹 Obsolete data cleaned", 'info');
      }

      // Mobile navigation mock functions
      function navigateQuestion(direction) {
        addToLog(`🧭 Navigate question: ${direction > 0 ? 'Next' : 'Previous'}`, 'info');
        return Promise.resolve();
      }

      function navigateToRandomQuestion() {
        addToLog("🎲 Navigate to random question", 'info');
        return Promise.resolve();
      }

      function toggleSidebar() {
        addToLog("🗂️ Toggle sidebar", 'info');
      }

      function closeSidebar() {
        addToLog("❌ Close sidebar", 'info');
      }

      // Enhanced navigation mock functions
      function getQuestionStatus(questionNumber) {
        return {
          primaryStatus: 'new',
          isFavorite: false,
          hasNotes: false,
          isCategorized: false
        };
      }

      function getAnsweredQuestionsCount() {
        return Math.floor(Math.random() * 20); // Mock answered count
      }

      function truncateText(text, maxLength) {
        return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
      }

      function saveSettings() {
        addToLog("💾 Settings saved", 'info');
      }

      function animateNumberChange(element, newValue) {
        if (element) element.textContent = newValue;
      }

      function addProgressMilestoneEffects(percentage) {
        addToLog(`🎯 Progress milestone: ${percentage.toFixed(1)}%`, 'info');
      }

      function resetMilestoneStates() {
        addToLog("🔄 Milestone states reset", 'info');
      }

      function hideExportModal() {
        addToLog("❌ Export modal hidden", 'info');
      }

      function showKeyboardHelp() {
        addToLog("⌨️ Keyboard help shown", 'info');
      }

      // Add some DOM elements for testing
      if (!document.getElementById('questionSection')) {
        const questionSection = document.createElement('div');
        questionSection.id = 'questionSection';
        questionSection.style.cssText = 'height: 200px; background: #f5f5f5; margin: 10px 0; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-weight: bold;';
        questionSection.innerHTML = '📱 Mock Question Section (for touch testing)';
        document.querySelector('.container').appendChild(questionSection);
      }

      if (!document.getElementById('sidebar')) {
        const sidebar = document.createElement('div');
        sidebar.id = 'sidebar';
        sidebar.style.cssText = 'position: fixed; top: 0; right: -300px; width: 300px; height: 100vh; background: white; border-left: 1px solid #ddd; transition: right 0.3s; z-index: 1000;';
        sidebar.innerHTML = '<div style="padding: 20px;">📱 Mock Sidebar (for swipe testing)</div>';
        document.body.appendChild(sidebar);
      }

      // Enhanced navigation DOM elements
      if (!document.getElementById('progressSidebar')) {
        const progressSidebar = document.createElement('div');
        progressSidebar.id = 'progressSidebar';
        progressSidebar.style.cssText = 'position: fixed; top: 0; right: -350px; width: 350px; height: 100vh; background: white; border-left: 1px solid #ddd; transition: right 0.3s; z-index: 1000;';
        progressSidebar.innerHTML = `
          <div style="padding: 20px;">
            <h3>🧭 Mock Progress Sidebar</h3>
            <div class="question-list" style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px;">
              Mock question list items will appear here
            </div>
            <div style="margin-top: 20px;">
              <div style="background: #e9ecef; height: 20px; border-radius: 10px; overflow: hidden;">
                <div id="overallProgress" style="background: #007bff; height: 100%; width: 0%; transition: width 0.3s;"></div>
              </div>
              <div id="progressText" style="margin-top: 5px; font-size: 12px; color: #666;">0/0 (0%)</div>
            </div>
          </div>
        `;
        document.body.appendChild(progressSidebar);
      }

      if (!document.getElementById('sidebarOverlay')) {
        const overlay = document.createElement('div');
        overlay.id = 'sidebarOverlay';
        overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; display: none;';
        document.body.appendChild(overlay);
      }

      if (!document.getElementById('historyBackBtn')) {
        const backBtn = document.createElement('button');
        backBtn.id = 'historyBackBtn';
        backBtn.innerHTML = '⬅️ Back';
        backBtn.style.cssText = 'margin: 5px; padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px;';
        document.querySelector('.container').appendChild(backBtn);
      }

      if (!document.getElementById('historyForwardBtn')) {
        const forwardBtn = document.createElement('button');
        forwardBtn.id = 'historyForwardBtn';
        forwardBtn.innerHTML = '➡️ Forward';
        forwardBtn.style.cssText = 'margin: 5px; padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px;';
        document.querySelector('.container').appendChild(forwardBtn);
      }

      if (!document.getElementById('sidebarToggle')) {
        const toggleBtn = document.createElement('button');
        toggleBtn.id = 'sidebarToggle';
        toggleBtn.innerHTML = '<i class="fas fa-bars"></i> Toggle Sidebar';
        toggleBtn.style.cssText = 'margin: 5px; padding: 8px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px;';
        document.querySelector('.container').appendChild(toggleBtn);
      }

      // Console logging system
      function addToLog(message, type = 'log') {
        const logContent = document.getElementById('log-content');
        const timestamp = new Date().toLocaleTimeString();
        const colors = {
          log: '#e2e8f0',
          error: '#fc8181',
          success: '#68d391',
          info: '#63b3ed'
        };
        
        logContent.innerHTML += `<div style="color: ${colors[type]}; margin: 2px 0;">[${timestamp}] ${message}</div>`;
        logContent.scrollTop = logContent.scrollHeight;
      }

      // Override console methods to capture output
      const originalLog = console.log;
      const originalError = console.error;
      
      console.log = function(...args) {
        addToLog(args.join(' '), 'log');
        originalLog.apply(console, args);
      };
      
      console.error = function(...args) {
        addToLog(args.join(' '), 'error');
        originalError.apply(console, args);
      };
    </script>

    <!-- Load modular script -->
    <script type="module">
      import {
        isDevelopmentMode,
        devLog,
        devError,
        clearCorruptedData,
        saveStatistics,
        loadStatistics,
        saveFavorites,
        loadFavorites,
        loadSettings,
        saveSettings,
        loadResumePositions,
        saveResumePositions,
        saveResumePosition,
        getResumePosition,
        clearResumePosition,
      } from './js/modules/storage.js';

      // Also import settings module
      import {
        applyTheme,
        loadSettingsUI,
        saveSettingsUI,
        updateToolbarVisibility,
        updateTooltipVisibility,
        updateAdvancedSearchVisibility,
        setupSettingsEventListeners,
        initializeSettings,
      } from './js/modules/settings.js';

      // Also import data models module
      import {
        ExamSession,
        QuestionAttempt,
        compressData,
        decompressData,
        startExamSession,
        endCurrentSession,
        trackQuestionAttempt,
        trackQuestionVisit,
      } from './js/core/models.js';

      // Also import UI effects module
      import {
        showLoading,
        showError,
        showSuccess,
        addProgressMilestoneEffects,
        triggerMilestoneAnimation,
        hideMainProgressBar,
        resetMilestoneStates,
        animateNumberChange,
        updateMainProgressBarVisibility,
        showExportModal,
        hideExportModal,
        showKeyboardHelp,
        closeKeyboardHelp,
        displayChangelog,
        toggleSidebar,
        toggleSearchSection,
        toggleLegalInfo,
        showValidationResults,
        showQuestionNumberSuggestions,
        hideAutocompleteSuggestions,
        renderMarkdown,
      } from './js/modules/ui-effects.js';

      // Also import statistics module
      import {
        recalculateTotalStats,
        getCurrentSessionStats,
        getGlobalStats,
        updateSessionStats,
        updateGlobalStats,
        isQuestionAnswered,
        getMostRecentAnswer,
        getQuestionStatus,
        cleanCorruptedStatistics,
        clearQuestionStatusCache,
      } from './js/modules/statistics.js';

      // Also import favorites module
      import {
        toggleQuestionFavorite,
        isQuestionFavorite,
        getQuestionFavoriteData,
        getCurrentExamFavorites,
        updateQuestionNote,
        getQuestionNote,
        addCustomCategory,
        removeCustomCategory,
        getAllCategories,
        updateQuestionCategory,
        toggleRevisionMode,
        updateRevisionFilter,
        getFilteredQuestions,
        getFavoritesStats,
        cleanupObsoleteData,
      } from './js/modules/favorites.js';

      // Also import search module
      import {
        initializeSearchInterface,
        resetSearchState,
        getSearchState,
        clearSearchCache,
        searchQuestions,
        applyTextSearch,
        applyStatusFilters,
        applyCurrentFilters,
        resetAllFilters,
        getQuestionNumberSuggestions,
        showAutocompleteSuggestions,
        updateFilterCounts,
        handleSearchInput,
        handleFilterChange,
        setupSearchEventListeners,
      } from './js/modules/search.js';

      // Also import resume position module
      import {
        saveStudyPosition,
        getStudyPosition,
        clearStudyPosition,
        autoSavePosition,
        setupAutoSave,
        showResumeDialog,
        checkAndShowResumeDialog,
        resumeToPosition,
        validateSavedPosition,
        cleanInvalidPositions,
        initializeResumePosition,
        handleNavigationChange,
      } from './js/modules/resume-position.js';

      // Also import mobile navigation module
      import {
        setupMobileTooltips,
        setupTouchGestures,
        manageSwipeIndicators,
        createSwipeIndicators,
        showSwipeIndicator,
        hideSwipeIndicators,
        addHapticFeedback,
        setupTouchFeedback,
        createMobileBottomNavigation,
        setupSidebarSwipeToClose,
        handleMobileResize,
        setupMobileResizeListener,
        isMobileDevice,
        refreshMobileNavigation,
        initializeMobileNavigation,
      } from './js/modules/mobile-navigation.js';

      // Also import enhanced navigation module
      import {
        addToNavigationHistory,
        navigateHistoryBack,
        navigateHistoryForward,
        updateHistoryButtons,
        clearNavigationHistory,
        getNavigationHistoryState,
        toggleSidebar,
        openSidebar,
        closeSidebar,
        isSidebarOpen,
        updateProgressSidebar,
        updateProgressBar,
        updateMainProgressBar,
        getFavoritesCount,
        setupKeyboardShortcuts,
        handleKeyboardShortcuts,
        removeKeyboardShortcuts,
        initializeEnhancedNavigation,
        refreshEnhancedNavigation,
        navigateToQuestionWithHistory,
      } from './js/modules/enhanced-navigation.js';

      addToLog("📦 Storage module imported successfully!", 'success');
      addToLog("⚙️ Settings module imported successfully!", 'success');
      addToLog("🏗️ Data Models module imported successfully!", 'success');
      addToLog("🎨 UI Effects module imported successfully!", 'success');
      addToLog("📊 Statistics module imported successfully!", 'success');
      addToLog("⭐ Favorites module imported successfully!", 'success');
      addToLog("🔍 Search module imported successfully!", 'success');
      addToLog("📍 Resume Position module imported successfully!", 'success');
      addToLog("📱 Mobile Navigation module imported successfully!", 'success');
      addToLog("🧭 Enhanced Navigation module imported successfully!", 'success');

      // Make functions available globally for testing
      window.applyTheme = applyTheme;
      window.loadSettingsUI = loadSettingsUI;
      window.navigateQuestion = navigateQuestion;
      window.navigateToRandomQuestion = navigateToRandomQuestion;
      window.toggleSidebar = toggleSidebar;
      window.closeSidebar = closeSidebar;
      window.getQuestionStatus = getQuestionStatus;
      window.getAnsweredQuestionsCount = getAnsweredQuestionsCount;
      window.truncateText = truncateText;
      window.saveSettings = saveSettings;
      window.animateNumberChange = animateNumberChange;
      window.addProgressMilestoneEffects = addProgressMilestoneEffects;
      window.resetMilestoneStates = resetMilestoneStates;
      window.hideExportModal = hideExportModal;
      window.showKeyboardHelp = showKeyboardHelp;
      window.saveSettingsUI = saveSettingsUI;
      window.updateToolbarVisibility = updateToolbarVisibility;
      window.updateTooltipVisibility = updateTooltipVisibility;
      window.updateAdvancedSearchVisibility = updateAdvancedSearchVisibility;
      window.setupSettingsEventListeners = setupSettingsEventListeners;
      window.initializeSettings = initializeSettings;

      // Make data models functions available globally for testing
      window.ExamSession = ExamSession;
      window.QuestionAttempt = QuestionAttempt;
      window.compressData = compressData;
      window.decompressData = decompressData;
      window.startExamSession = startExamSession;
      window.endCurrentSession = endCurrentSession;
      window.trackQuestionAttempt = trackQuestionAttempt;
      window.trackQuestionVisit = trackQuestionVisit;

      // Make UI effects functions available globally for testing
      window.showLoading = showLoading;
      window.showError = showError;
      window.showSuccess = showSuccess;
      window.showSwipeIndicator = showSwipeIndicator;
      window.hideSwipeIndicators = hideSwipeIndicators;
      window.addHapticFeedback = addHapticFeedback;
      window.addProgressMilestoneEffects = addProgressMilestoneEffects;
      window.triggerMilestoneAnimation = triggerMilestoneAnimation;
      window.hideMainProgressBar = hideMainProgressBar;
      window.resetMilestoneStates = resetMilestoneStates;
      window.animateNumberChange = animateNumberChange;
      window.updateMainProgressBarVisibility = updateMainProgressBarVisibility;
      window.showExportModal = showExportModal;
      window.hideExportModal = hideExportModal;
      window.showKeyboardHelp = showKeyboardHelp;
      window.closeKeyboardHelp = closeKeyboardHelp;
      window.displayChangelog = displayChangelog;
      window.toggleSidebar = toggleSidebar;
      window.toggleSearchSection = toggleSearchSection;
      window.toggleLegalInfo = toggleLegalInfo;
      window.showValidationResults = showValidationResults;
      window.showQuestionNumberSuggestions = showQuestionNumberSuggestions;
      window.hideAutocompleteSuggestions = hideAutocompleteSuggestions;
      window.renderMarkdown = renderMarkdown;

      // Make statistics functions available globally for testing
      window.recalculateTotalStats = recalculateTotalStats;
      window.getCurrentSessionStats = getCurrentSessionStats;
      window.getGlobalStats = getGlobalStats;
      window.updateSessionStats = updateSessionStats;
      window.updateGlobalStats = updateGlobalStats;
      window.isQuestionAnswered = isQuestionAnswered;
      window.getMostRecentAnswer = getMostRecentAnswer;
      window.getQuestionStatus = getQuestionStatus;
      window.cleanCorruptedStatistics = cleanCorruptedStatistics;
      window.clearQuestionStatusCache = clearQuestionStatusCache;

      // Make favorites functions available globally for testing
      window.toggleQuestionFavorite = toggleQuestionFavorite;
      window.isQuestionFavorite = isQuestionFavorite;
      window.getQuestionFavoriteData = getQuestionFavoriteData;
      window.getCurrentExamFavorites = getCurrentExamFavorites;
      window.updateQuestionNote = updateQuestionNote;
      window.getQuestionNote = getQuestionNote;
      window.addCustomCategory = addCustomCategory;
      window.removeCustomCategory = removeCustomCategory;
      window.getAllCategories = getAllCategories;
      window.updateQuestionCategory = updateQuestionCategory;
      window.toggleRevisionMode = toggleRevisionMode;
      window.updateRevisionFilter = updateRevisionFilter;
      window.getFilteredQuestions = getFilteredQuestions;
      window.getFavoritesStats = getFavoritesStats;
      window.cleanupObsoleteData = cleanupObsoleteData;

      // Make search functions available globally for testing
      window.initializeSearchInterface = initializeSearchInterface;
      window.resetSearchState = resetSearchState;
      window.getSearchState = getSearchState;
      window.clearSearchCache = clearSearchCache;
      window.searchQuestions = searchQuestions;
      window.applyTextSearch = applyTextSearch;
      window.applyStatusFilters = applyStatusFilters;
      window.applyCurrentFilters = applyCurrentFilters;
      window.resetAllFilters = resetAllFilters;
      window.getQuestionNumberSuggestions = getQuestionNumberSuggestions;
      window.showAutocompleteSuggestions = showAutocompleteSuggestions;
      window.updateFilterCounts = updateFilterCounts;
      window.handleSearchInput = handleSearchInput;
      window.handleFilterChange = handleFilterChange;
      window.setupSearchEventListeners = setupSearchEventListeners;

      // Make resume position functions available globally for testing
      window.saveStudyPosition = saveStudyPosition;
      window.getStudyPosition = getStudyPosition;
      window.clearStudyPosition = clearStudyPosition;
      window.autoSavePosition = autoSavePosition;
      window.setupAutoSave = setupAutoSave;
      window.showResumeDialog = showResumeDialog;
      window.checkAndShowResumeDialog = checkAndShowResumeDialog;
      window.resumeToPosition = resumeToPosition;
      window.validateSavedPosition = validateSavedPosition;
      window.cleanInvalidPositions = cleanInvalidPositions;
      window.initializeResumePosition = initializeResumePosition;
      window.handleNavigationChange = handleNavigationChange;

      // Initialize settings module
      initializeSettings();

      // Test functions
      window.testStorage = function() {
        addToLog("🧪 Testing Storage Functions...", 'info');
        
        // Test statistics
        statistics.totalStats.totalQuestions = 42;
        saveStatistics();
        addToLog("✅ Statistics saved", 'success');
        
        statistics.totalStats.totalQuestions = 0; // Reset
        loadStatistics();
        addToLog(`📊 Statistics loaded - totalQuestions: ${statistics.totalStats.totalQuestions}`, 'info');
        
        // Test favorites
        favoritesData.favorites['TEST'] = { 1: { isFavorite: true, note: 'Test note' } };
        saveFavorites();
        addToLog("⭐ Favorites saved", 'success');
        
        favoritesData.favorites = {}; // Reset
        loadFavorites();
        const testFav = favoritesData.favorites['TEST'];
        addToLog(`⭐ Favorites loaded - TEST exam has ${Object.keys(testFav || {}).length} items`, 'info');
        
        // Test resume positions
        saveResumePosition('TEST-EXAM', 5);
        addToLog("📍 Resume position saved", 'success');
        
        const position = getResumePosition('TEST-EXAM');
        addToLog(`📍 Resume position loaded - question ${position?.questionNumber || 'none'}`, 'info');
      };

      window.testCompression = function() {
        addToLog("🗜️ Testing Compression...", 'info');
        
        const testData = {
          sessions: [
            { examCode: 'TEST', examName: 'Test Exam', totalQuestions: 100 }
          ],
          totalStats: { totalQuestions: 50, totalCorrect: 30 }
        };
        
        const compressed = compressData(testData);
        addToLog(`📦 Original size: ${JSON.stringify(testData).length} chars`, 'info');
        addToLog(`📦 Compressed size: ${compressed.length} chars`, 'info');
        
        const decompressed = decompressData(compressed);
        const matches = JSON.stringify(testData) === JSON.stringify(decompressed);
        addToLog(`🔄 Compression/Decompression: ${matches ? '✅ SUCCESS' : '❌ FAILED'}`, matches ? 'success' : 'error');
      };

      window.testDevMode = function() {
        addToLog("🔧 Testing Development Mode...", 'info');
        
        const isDevMode = isDevelopmentMode();
        addToLog(`🔧 Development mode: ${isDevMode ? '✅ ENABLED' : '❌ DISABLED'}`, isDevMode ? 'success' : 'info');
        
        devLog("This is a dev log message");
        devError("This is a dev error message");
      };

      // Test mobile navigation module
      window.testMobile = function() {
        addToLog("📱 Testing Mobile Navigation Module...", 'info');
        
        // Test device detection
        const isMobile = isMobileDevice();
        addToLog(`📱 Device type: ${isMobile ? 'Mobile' : 'Desktop'} (width: ${window.innerWidth}px)`, 'info');
        
        // Test haptic feedback (if available)
        addToLog("🔊 Testing haptic feedback...", 'info');
        addHapticFeedback();
        addToLog("🔊 Haptic feedback triggered (vibration if supported)", 'success');
        
        // Test swipe indicators
        addToLog("👈👉 Testing swipe indicators...", 'info');
        manageSwipeIndicators();
        createSwipeIndicators();
        addToLog("👈👉 Swipe indicators managed", 'success');
        
        // Test mobile tooltips setup
        addToLog("💬 Testing mobile tooltips setup...", 'info');
        setupMobileTooltips();
        addToLog("💬 Mobile tooltips configured", 'success');
        
        // Test touch feedback setup
        addToLog("👆 Testing touch feedback setup...", 'info');
        setupTouchFeedback();
        addToLog("👆 Touch feedback configured", 'success');
        
        // Test mobile bottom navigation
        addToLog("🔢 Testing mobile bottom navigation...", 'info');
        createMobileBottomNavigation();
        const mobileNav = document.getElementById('mobileBottomNav');
        if (isMobile && window.currentQuestions?.length > 0) {
          addToLog(`🔢 Mobile nav: ${mobileNav ? '✅ CREATED' : '❌ NOT CREATED'}`, mobileNav ? 'success' : 'info');
        } else {
          addToLog("🔢 Mobile nav: Not needed (desktop or no exam loaded)", 'info');
        }
        
        // Test sidebar swipe-to-close
        addToLog("🗂️ Testing sidebar swipe-to-close...", 'info');
        setupSidebarSwipeToClose();
        addToLog("🗂️ Sidebar swipe-to-close configured", 'success');
        
        // Test resize listener
        addToLog("📏 Testing resize listener...", 'info');
        setupMobileResizeListener();
        addToLog("📏 Resize listener configured", 'success');
        
        // Test mobile navigation initialization
        addToLog("🚀 Testing mobile navigation initialization...", 'info');
        initializeMobileNavigation();
        addToLog("🚀 Mobile navigation fully initialized", 'success');
        
        addToLog("📱 Mobile Navigation Module test completed!", 'success');
      };

      // Test enhanced navigation module
      window.testEnhanced = function() {
        addToLog("🧭 Testing Enhanced Navigation Module...", 'info');
        
        // Test navigation history management
        addToLog("📚 Testing navigation history...", 'info');
        clearNavigationHistory();
        addToNavigationHistory(0);
        addToNavigationHistory(5);
        addToNavigationHistory(10);
        
        const historyState = getNavigationHistoryState();
        addToLog(`✅ History: ${historyState.totalEntries} entries, can go back: ${historyState.canGoBack}`, 'success');
        
        // Test history navigation (mock)
        addToLog("⬅️ Testing history back navigation...", 'info');
        navigateHistoryBack();
        const backState = getNavigationHistoryState();
        addToLog(`✅ After back: index ${backState.currentIndex}, can go forward: ${backState.canGoForward}`, 'success');
        
        // Test history forward navigation (mock)
        addToLog("➡️ Testing history forward navigation...", 'info');
        navigateHistoryForward();
        const forwardState = getNavigationHistoryState();
        addToLog(`✅ After forward: index ${forwardState.currentIndex}`, 'success');
        
        // Test sidebar management
        addToLog("🗂️ Testing sidebar management...", 'info');
        const initialSidebarState = isSidebarOpen();
        addToLog(`📊 Initial sidebar state: ${initialSidebarState ? 'Open' : 'Closed'}`, 'info');
        
        toggleSidebar();
        const toggledState = isSidebarOpen();
        addToLog(`🔄 After toggle: ${toggledState ? 'Open' : 'Closed'}`, 'success');
        
        openSidebar();
        addToLog(`✅ Open sidebar: ${isSidebarOpen() ? 'Success' : 'Failed'}`, isSidebarOpen() ? 'success' : 'error');
        
        closeSidebar();
        addToLog(`✅ Close sidebar: ${!isSidebarOpen() ? 'Success' : 'Failed'}`, !isSidebarOpen() ? 'success' : 'error');
        
        // Test progress sidebar update
        addToLog("📊 Testing progress sidebar update...", 'info');
        updateProgressSidebar();
        addToLog("✅ Progress sidebar updated", 'success');
        
        // Test progress bars
        addToLog("📈 Testing progress bars...", 'info');
        updateProgressBar();
        updateMainProgressBar();
        addToLog("✅ Progress bars updated", 'success');
        
        // Test favorites count
        addToLog("⭐ Testing favorites count...", 'info');
        const favCount = getFavoritesCount();
        addToLog(`✅ Favorites count: ${favCount}`, 'success');
        
        // Test keyboard shortcuts setup
        addToLog("⌨️ Testing keyboard shortcuts setup...", 'info');
        setupKeyboardShortcuts();
        addToLog("✅ Keyboard shortcuts configured", 'success');
        
        // Test enhanced navigation initialization
        addToLog("🚀 Testing enhanced navigation initialization...", 'info');
        initializeEnhancedNavigation();
        addToLog("✅ Enhanced navigation initialized", 'success');
        
        // Test navigation refresh
        addToLog("🔄 Testing enhanced navigation refresh...", 'info');
        refreshEnhancedNavigation();
        addToLog("✅ Enhanced navigation refreshed", 'success');
        
        // Test question navigation with history
        addToLog("🧭 Testing question navigation with history...", 'info');
        
        // Mock navigation function for testing
        window.navigateToQuestionIndex = (index, addHistory) => {
          window.currentQuestionIndex = index;
          addToLog(`🧭 Navigated to question ${index + 1} (addHistory: ${addHistory !== false})`, 'info');
          return Promise.resolve();
        };
        
        navigateToQuestionWithHistory(3);
        const finalHistoryState = getNavigationHistoryState();
        addToLog(`✅ Navigation with history: ${finalHistoryState.totalEntries} total entries`, 'success');
        
        addToLog("🧭 Enhanced Navigation Module test completed!", 'success');
      };

      // Test settings module
      window.testSettings = function() {
        addToLog("⚙️ Testing Settings Module...", 'info');
        
        // Test settings load/save
        addToLog("💾 Testing settings save/load cycle", 'info');
        
        // Modify a setting
        const darkModeToggle = document.getElementById('darkModeToggle');
        const originalState = darkModeToggle.checked;
        darkModeToggle.checked = !originalState;
        
        // Save settings
        saveSettingsUI();
        addToLog(`✅ Settings saved - darkMode: ${darkModeToggle.checked}`, 'success');
        
        // Reset and reload
        darkModeToggle.checked = originalState;
        loadSettingsUI();
        addToLog(`📂 Settings loaded - darkMode: ${darkModeToggle.checked}`, 'info');
        
        // Test UI visibility functions
        addToLog("🔧 Testing UI visibility functions", 'info');
        updateMainProgressBarVisibility();
        updateToolbarVisibility();
        updateTooltipVisibility();
        updateAdvancedSearchVisibility();
        addToLog("✅ UI visibility functions executed", 'success');
      };

      // Test theme toggling
      window.testTheme = function() {
        addToLog("🎨 Testing Theme Toggle...", 'info');
        
        const currentTheme = document.body.classList.contains('dark-mode');
        addToLog(`🎨 Current theme: ${currentTheme ? 'Dark' : 'Light'}`, 'info');
        
        // Toggle theme
        applyTheme(!currentTheme);
        const newTheme = document.body.classList.contains('dark-mode');
        addToLog(`🎨 New theme: ${newTheme ? 'Dark' : 'Light'}`, newTheme !== currentTheme ? 'success' : 'error');
        
        // Toggle back
        setTimeout(() => {
          applyTheme(currentTheme);
          addToLog(`🔄 Reverted to original theme: ${currentTheme ? 'Dark' : 'Light'}`, 'info');
        }, 1000);
      };

      // Test data models
      window.testModels = function() {
        addToLog("🏗️ Testing Data Models...", 'info');
        
        // Test ExamSession class
        addToLog("📝 Testing ExamSession class", 'info');
        const session = new ExamSession('TEST-EXAM', 'Test Exam Name');
        addToLog(`✅ Session created - ID: ${session.id}, Code: ${session.examCode}`, 'success');
        
        // Test QuestionAttempt class
        addToLog("❓ Testing QuestionAttempt class", 'info');
        const attempt = new QuestionAttempt(1, ['A', 'B']);
        attempt.addAttempt(['A'], false, 10, false);
        attempt.addAttempt(['A', 'B'], true, 15, true);
        addToLog(`✅ Question attempt created - Final score: ${attempt.finalScore}%`, 'success');
        addToLog(`📊 Attempts: ${attempt.attempts.length}, Time: ${attempt.timeSpent}s`, 'info');
        
        // Test compression/decompression
        addToLog("🗜️ Testing compression with model data", 'info');
        
        // Create test data with full property names (not compressed)
        const testData = {
          sessions: [{
            id: "test-session-123",
            examCode: "TEST-EXAM",
            examName: "Test Exam Name",
            startTime: Date.now(),
            endTime: null,
            questions: [],
            visitedQuestions: [],
            totalQuestions: 100,
            correctAnswers: 0,
            incorrectAnswers: 0,
            previewAnswers: 0,
            totalTime: 0,
            completed: false
          }],
          currentSession: null,
          totalStats: { 
            totalQuestions: 10, 
            totalCorrect: 7,
            totalIncorrect: 3,
            totalPreview: 0,
            totalTime: 0,
            examStats: {}
          }
        };
        
        const compressed = compressData(testData);
        const decompressed = decompressData(compressed);
        const matches = JSON.stringify(testData) === JSON.stringify(decompressed);
        addToLog(`🔄 Model compression test: ${matches ? '✅ SUCCESS' : '❌ FAILED'}`, matches ? 'success' : 'error');
        addToLog(`📦 Compression ratio: ${(compressed.length / JSON.stringify(testData).length * 100).toFixed(1)}%`, 'info');
      };

      // Test session management
      window.testSession = function() {
        addToLog("📝 Testing Session Management...", 'info');
        
        // Initialize statistics if not exists
        if (!statistics.sessions) {
          statistics.sessions = [];
        }
        
        // Start a new session
        addToLog("🚀 Starting new exam session", 'info');
        const session = startExamSession('TEST-EXAM-2', 'Test Exam Session');
        addToLog(`✅ Session started - ID: ${session?.id || 'N/A'}`, session ? 'success' : 'error');
        
        // Track some question visits
        addToLog("👀 Tracking question visits", 'info');
        trackQuestionVisit(1);
        trackQuestionVisit(2);
        trackQuestionVisit(3);
        addToLog(`📊 Visited questions: ${statistics.currentSession?.visitedQuestions?.length || 0}`, 'info');
        
        // Track question attempts
        addToLog("❓ Tracking question attempts", 'info');
        trackQuestionAttempt(1, ['A'], ['A', 'B'], false, 10);
        trackQuestionAttempt(1, ['A', 'B'], ['A', 'B'], true, 15);
        addToLog(`✅ Question attempts tracked`, 'success');
        
        // End session
        addToLog("🏁 Ending current session", 'info');
        const endedSession = endCurrentSession();
        addToLog(`✅ Session ended - Total time: ${endedSession?.totalTime || 0}s`, 'success');
        addToLog(`📊 Total sessions: ${statistics.sessions?.length || 0}`, 'info');
      };

      // Test UI effects
      window.testUIEffects = function() {
        addToLog("🎨 Testing UI Effects...", 'info');
        
        // Test loading indicator
        addToLog("⏳ Testing loading indicator", 'info');
        showLoading(true);
        setTimeout(() => {
          showLoading(false);
          addToLog("✅ Loading indicator test completed", 'success');
        }, 1000);
        
        // Test error/success messages
        addToLog("📢 Testing message display", 'info');
        setTimeout(() => {
          showError("This is a test error message");
          addToLog("❌ Error message displayed", 'info');
        }, 1500);
        
        setTimeout(() => {
          showSuccess("This is a test success message");
          addToLog("✅ Success message displayed", 'success');
        }, 2500);
        
        // Test swipe indicators
        addToLog("👆 Testing swipe indicators", 'info');
        setTimeout(() => {
          showSwipeIndicator('left');
          setTimeout(() => showSwipeIndicator('right'), 500);
          addToLog("📱 Swipe indicators tested", 'success');
        }, 4000);
        
        // Test haptic feedback
        addToLog("📳 Testing haptic feedback", 'info');
        setTimeout(() => {
          addHapticFeedback();
          addToLog("📳 Haptic feedback triggered", 'info');
        }, 5000);
        
        // Test number animation
        addToLog("🔢 Testing number animation", 'info');
        const testElement = document.createElement('div');
        testElement.id = 'numberTest';
        testElement.style.cssText = 'font-size: 2em; margin: 10px; color: #007bff;';
        testElement.textContent = '0';
        document.querySelector('.test-section').appendChild(testElement);
        
        setTimeout(() => {
          animateNumberChange(testElement, 100);
          addToLog("🔢 Number animation from 0 to 100", 'success');
        }, 5500);
        
        setTimeout(() => {
          testElement.remove();
          addToLog("🧹 Cleaned up test element", 'info');
        }, 7000);
      };

      // Test modals
      window.testModals = function() {
        addToLog("📱 Testing Modals...", 'info');
        
        // Test keyboard help modal
        addToLog("⌨️ Testing keyboard help modal", 'info');
        showKeyboardHelp();
        addToLog("✅ Keyboard help modal opened", 'success');
        
        setTimeout(() => {
          closeKeyboardHelp();
          addToLog("❌ Keyboard help modal closed", 'info');
        }, 2000);
        
        // Test validation results
        addToLog("✅ Testing validation feedback", 'info');
        setTimeout(() => {
          // Create temporary validation element
          const validationElement = document.createElement('div');
          validationElement.id = 'answerInstructions';
          validationElement.style.cssText = 'margin: 10px; padding: 10px; border-radius: 4px;';
          document.querySelector('.test-section').appendChild(validationElement);
          
          // Simulate selected answers
          window.selectedAnswers = new Set(['A', 'B']);
          showValidationResults(['A', 'B']);
          addToLog("✅ Correct answer validation displayed", 'success');
          
          setTimeout(() => {
            window.selectedAnswers = new Set(['A']);
            showValidationResults(['A', 'B']);
            addToLog("⚠️ Incorrect answer validation displayed", 'info');
          }, 1500);
          
          setTimeout(() => {
            validationElement.remove();
            addToLog("🧹 Cleaned up validation test", 'info');
          }, 3000);
        }, 2500);
        
        // Test toggle functions
        addToLog("🔄 Testing toggle functions", 'info');
        setTimeout(() => {
          toggleLegalInfo();
          addToLog("📋 Legal info toggled", 'info');
          setTimeout(() => toggleLegalInfo(), 1000);
        }, 6000);
      };

      // Test statistics module
      window.testStatistics = function() {
        addToLog("📊 Testing Statistics Module...", 'info');
        
        try {
          // Initialize statistics object if not exists
          if (!window.statistics) {
            window.statistics = {
              sessions: [],
              currentSession: null,
              totalStats: {
                totalQuestions: 0,
                totalCorrect: 0,
                totalIncorrect: 0,
                totalPreview: 0,
                totalTime: 0,
                examStats: {},
              }
            };
          }

          // Create test session data
          addToLog("🎯 Creating test session data", 'info');
          window.statistics.sessions = [
            {
              examCode: "TEST-001",
              examName: "Test Exam 1",
              startTime: Date.now() - 3600000, // 1 hour ago
              endTime: Date.now() - 3000000,   // 50 minutes ago
              totalQuestions: 50,
              correctAnswers: 35,
              incorrectAnswers: 10,
              previewAnswers: 5,
              totalTime: 600, // 10 minutes
              completed: true,
              questions: [
                { questionNumber: 1, userAnswers: ['A'], endTime: Date.now() - 3500000 },
                { questionNumber: 2, userAnswers: ['B', 'C'], endTime: Date.now() - 3400000 }
              ]
            },
            {
              examCode: "TEST-002", 
              examName: "Test Exam 2",
              startTime: Date.now() - 1800000, // 30 minutes ago
              endTime: Date.now() - 900000,    // 15 minutes ago
              totalQuestions: 30,
              correctAnswers: 20,
              incorrectAnswers: 8,
              previewAnswers: 2,
              totalTime: 450, // 7.5 minutes
              completed: true
            }
          ];

          // Test global stats calculation
          addToLog("📈 Testing global stats calculation", 'info');
          recalculateTotalStats();
          const globalStats = getGlobalStats();
          addToLog(`✅ Global stats: ${globalStats.totalQuestions} questions, ${globalStats.overallAccuracy}% accuracy`, 'success');
          addToLog(`📊 Total sessions: ${globalStats.totalSessions}, Exams: ${globalStats.examsCount}`, 'info');

          // Test current session (simulate active session)
          addToLog("⏱️ Testing current session stats", 'info');
          window.statistics.currentSession = {
            examCode: "TEST-CURRENT",
            examName: "Current Test",
            startTime: Date.now() - 300000, // 5 minutes ago
            totalQuestions: 20,
            correctAnswers: 12,
            incorrectAnswers: 3,
            previewAnswers: 1,
            totalTime: 240 // 4 minutes
          };

          const currentStats = getCurrentSessionStats();
          addToLog(`✅ Current session: ${currentStats.accuracy}% accuracy, ${currentStats.totalAnswered} answered`, 'success');

          // Test question status tracking
          addToLog("❓ Testing question status tracking", 'info');
          window.currentExam = { exam_code: "TEST-001", exam_name: "Test Exam 1" };
          
          const isAnswered = isQuestionAnswered(0); // Check first question
          addToLog(`✅ Question 1 answered: ${isAnswered}`, 'success');
          
          if (isAnswered) {
            const recentAnswer = getMostRecentAnswer(0);
            addToLog(`📝 Most recent answer: ${recentAnswer ? recentAnswer.join(', ') : 'None'}`, 'info');
          }

          // Test question status cache
          addToLog("💾 Testing question status cache", 'info');
          const questionStatus = getQuestionStatus(0);
          addToLog(`✅ Question status cached: ${questionStatus.isAnswered}`, 'success');
          
          clearQuestionStatusCache();
          addToLog("🗑️ Question status cache cleared", 'info');

          // Test data cleanup
          addToLog("🧹 Testing data cleanup", 'info');
          cleanCorruptedStatistics();
          addToLog("✅ Statistics cleaned successfully", 'success');

          // Display updated global stats
          recalculateTotalStats();
          const finalStats = getGlobalStats();
          addToLog(`📊 Final stats: ${finalStats.totalCorrect}/${finalStats.totalQuestions} (${finalStats.overallAccuracy}%)`, 'success');
          addToLog(`⏱️ Total time: ${Math.round(finalStats.totalTime / 60)} minutes`, 'info');

        } catch (error) {
          addToLog(`❌ Statistics test failed: ${error.message}`, 'error');
        }
      };

      // Test favorites module
      window.testFavorites = function() {
        addToLog("⭐ Testing Favorites Module...", 'info');
        
        try {
          // Initialize favorites data if not exists
          if (!window.favoritesData) {
            window.favoritesData = {
              favorites: {},
              categories: ["Important", "Review", "Difficult"],
              customCategories: [],
              isRevisionMode: false,
              revisionFilter: {
                showFavorites: true,
                showCategories: [],
                showNotes: true,
              },
            };
          }

          // Set up test exam
          window.currentExam = { exam_code: "FAV-TEST", exam_name: "Favorites Test Exam" };
          window.currentQuestions = new Array(10).fill().map((_, i) => ({ 
            question_number: i + 1, 
            question: `Test question ${i + 1}` 
          }));

          // Test favorites management
          addToLog("⭐ Testing favorites management", 'info');
          
          // Add question to favorites
          const success = toggleQuestionFavorite(0, 'Important');
          addToLog(`✅ Toggle favorite result: ${success}`, success ? 'success' : 'error');
          
          // Check if question is favorite
          const isFavorite = isQuestionFavorite(0);
          addToLog(`✅ Question 1 is favorite: ${isFavorite}`, 'success');
          
          // Get favorite data
          const favoriteData = getQuestionFavoriteData(0);
          addToLog(`📝 Favorite data: ${favoriteData ? favoriteData.category : 'None'}`, 'info');

          // Test notes management
          addToLog("📝 Testing notes management", 'info');
          
          const noteSuccess = updateQuestionNote(0, "This is a test note for question 1");
          addToLog(`✅ Add note result: ${noteSuccess}`, noteSuccess ? 'success' : 'error');
          
          const note = getQuestionNote(0);
          addToLog(`📄 Retrieved note: "${note}"`, 'info');

          // Test custom categories
          addToLog("📁 Testing custom categories", 'info');
          
          const categorySuccess = addCustomCategory("My Custom Category");
          addToLog(`✅ Add custom category: ${categorySuccess}`, categorySuccess ? 'success' : 'error');
          
          const allCategories = getAllCategories();
          addToLog(`📁 All categories: ${allCategories.join(', ')}`, 'info');
          
          // Update question category
          const updateCatSuccess = updateQuestionCategory(0, "My Custom Category");
          addToLog(`✅ Update category: ${updateCatSuccess}`, updateCatSuccess ? 'success' : 'error');

          // Test revision mode
          addToLog("🔄 Testing revision mode", 'info');
          
          const revisionMode = toggleRevisionMode();
          addToLog(`✅ Revision mode: ${revisionMode ? 'ON' : 'OFF'}`, 'success');
          
          // Update revision filter
          const filterSuccess = updateRevisionFilter({
            showFavorites: true,
            showCategories: ["My Custom Category"],
            showNotes: true
          });
          addToLog(`✅ Filter update: ${filterSuccess}`, filterSuccess ? 'success' : 'error');

          // Test filtered questions
          const filteredQuestions = getFilteredQuestions();
          addToLog(`🔍 Filtered questions: ${filteredQuestions.length} questions`, 'info');

          // Test favorites statistics
          addToLog("📊 Testing favorites statistics", 'info');
          
          // Add more test favorites
          toggleQuestionFavorite(1, 'Review');
          updateQuestionNote(1, "Another test note");
          toggleQuestionFavorite(2, 'Difficult');
          
          const stats = getFavoritesStats();
          addToLog(`📊 Stats: ${stats.totalFavorites} favorites, ${stats.totalNotes} notes`, 'success');
          addToLog(`📁 Category counts: ${JSON.stringify(stats.categoryCounts)}`, 'info');

          // Test data cleanup
          addToLog("🧹 Testing data cleanup", 'info');
          const cleanupCount = cleanupObsoleteData();
          addToLog(`✅ Cleanup completed: ${cleanupCount} items cleaned`, 'success');

          // Test current exam favorites
          const examFavorites = getCurrentExamFavorites();
          addToLog(`⭐ Current exam favorites: ${Object.keys(examFavorites).length} items`, 'success');

          // Test removing category
          const removeSuccess = removeCustomCategory("My Custom Category");
          addToLog(`✅ Remove category: ${removeSuccess}`, removeSuccess ? 'success' : 'error');

        } catch (error) {
          addToLog(`❌ Favorites test failed: ${error.message}`, 'error');
        }
      };

      // Test search module
      window.testSearch = function() {
        addToLog("🔍 Testing Search Module...", 'info');
        
        try {
          // Create test questions with searchable content
          const testQuestions = [
            {
              question_number: 1,
              question: "What is JavaScript used for in web development?",
              answers: [
                { text: "Frontend scripting" },
                { text: "Backend development" },
                { text: "Database management" },
                { text: "All of the above" }
              ],
              comments: "JavaScript is a versatile programming language"
            },
            {
              question_number: 2,
              question: "Which HTML tag is used for creating links?",
              answers: [
                { text: "<a>" },
                { text: "<link>" },
                { text: "<href>" },
                { text: "<url>" }
              ],
              comments: "The anchor tag creates hyperlinks"
            },
            {
              question_number: 3,
              question: "What does CSS stand for?",
              answers: [
                { text: "Cascading Style Sheets" },
                { text: "Computer Style System" },
                { text: "Creative Style Solution" },
                { text: "Code Style Standard" }
              ],
              comments: "CSS controls the presentation and layout"
            },
            {
              question_number: 4,
              question: "Which JavaScript framework is popular for building user interfaces?",
              answers: [
                { text: "React" },
                { text: "Express" },
                { text: "Node.js" },
                { text: "MongoDB" }
              ],
              comments: "React is a frontend JavaScript library"
            },
            {
              question_number: 5,
              question: "What is the purpose of HTML semantic elements?",
              answers: [
                { text: "Better structure and meaning" },
                { text: "Faster loading" },
                { text: "Better graphics" },
                { text: "Smaller file size" }
              ],
              comments: "Semantic HTML improves accessibility and SEO"
            }
          ];

          // Set up test environment
          window.currentQuestions = [...testQuestions];
          window.currentExam = { exam_code: "SEARCH-TEST", exam_name: "Search Test Exam" };

          // Initialize search interface
          addToLog("🔧 Initializing search interface", 'info');
          initializeSearchInterface();
          const initialState = getSearchState();
          addToLog(`✅ Initialized: ${initialState.totalQuestions} questions available`, 'success');

          // Test text search
          addToLog("🔍 Testing text search functionality", 'info');
          
          // Search for "JavaScript"
          const jsResults = searchQuestions("JavaScript");
          addToLog(`✅ "JavaScript" search: ${jsResults.length}/5 results`, 'success');
          
          // Search for "HTML"
          const htmlResults = searchQuestions("HTML");
          addToLog(`✅ "HTML" search: ${htmlResults.length}/5 results`, 'success');
          
          // Multi-word search
          const multiResults = searchQuestions("JavaScript framework");
          addToLog(`✅ "JavaScript framework" search: ${multiResults.length}/5 results`, 'success');

          // Test search application
          addToLog("🎯 Testing search application", 'info');
          applyTextSearch("CSS");
          addToLog(`✅ Applied "CSS" search: ${window.currentQuestions.length} questions`, 'success');

          // Test question number suggestions
          addToLog("💡 Testing auto-completion", 'info');
          const suggestions1 = getQuestionNumberSuggestions("1");
          addToLog(`✅ Suggestions for "1": ${suggestions1.length} items`, 'success');
          
          const suggestions3 = getQuestionNumberSuggestions("3");
          addToLog(`✅ Suggestions for "3": ${suggestions3.length} items`, 'success');

          // Test status filters (mock some data)
          addToLog("🔍 Testing status filters", 'info');
          
          // Mock some answered questions
          window.isQuestionAnswered = (index) => index < 2; // Questions 1-2 answered
          window.isQuestionFavorite = (index) => index === 0 || index === 2; // Questions 1 and 3 favorites

          // Reset to full question set for filter testing
          resetSearchState();
          
          // Test filter counts
          updateFilterCounts();
          addToLog("✅ Filter counts updated", 'success');

          // Test status filter application
          const answeredQuestions = applyStatusFilters(testQuestions);
          addToLog(`✅ Status filters: ${answeredQuestions.length} questions`, 'success');

          // Test search state management
          addToLog("📊 Testing search state management", 'info');
          const currentState = getSearchState();
          addToLog(`📊 Search state: ${currentState.filteredQuestions}/${currentState.totalQuestions} questions`, 'info');
          addToLog(`💾 Cache size: ${currentState.cacheSize} entries`, 'info');

          // Test cache clearing
          clearSearchCache();
          const clearedState = getSearchState();
          addToLog(`✅ Cache cleared: ${clearedState.cacheSize} entries`, 'success');

          // Test filter reset
          addToLog("🔄 Testing filter reset", 'info');
          resetAllFilters();
          addToLog(`✅ Filters reset: ${window.currentQuestions.length} questions`, 'success');

          // Test complex scenario: search + filters
          addToLog("🎯 Testing complex search scenario", 'info');
          
          // Apply text search
          applyTextSearch("web");
          addToLog(`🔍 Text search "web": ${window.currentQuestions.length} questions`, 'info');
          
          // Apply additional filters (this would need DOM elements in real scenario)
          addToLog("✅ Complex search scenario completed", 'success');

          // Final state report
          const finalState = getSearchState();
          addToLog(`📊 Final state: ${finalState.isSearchActive ? 'Active' : 'Inactive'} search`, 'success');
          addToLog(`📊 Questions: ${finalState.filteredQuestions}/${finalState.totalQuestions}`, 'info');

        } catch (error) {
          addToLog(`❌ Search test failed: ${error.message}`, 'error');
        }
      };

      // Test resume position module
      window.testResume = function() {
        addToLog("📍 Testing Resume Position Module...", 'info');
        
        try {
          // Enable resume position feature for testing
          if (!window.settings) {
            window.settings = {};
          }
          window.settings.enableResumePosition = true;
          window.settings.autoSavePosition = true;

          // Set up test exam and questions
          const testExamCode = "RESUME-TEST";
          window.currentExam = { 
            exam_code: testExamCode, 
            exam_name: "Resume Position Test Exam" 
          };
          window.currentQuestions = new Array(20).fill().map((_, i) => ({ 
            question_number: i + 1, 
            question: `Test question ${i + 1}` 
          }));
          window.currentQuestionIndex = 0;

          // Test basic position saving
          addToLog("💾 Testing position saving", 'info');
          
          const saveResult = saveStudyPosition(testExamCode, 5);
          addToLog(`✅ Save position result: ${saveResult}`, saveResult ? 'success' : 'error');
          
          // Test position retrieval
          addToLog("📍 Testing position retrieval", 'info');
          
          const savedPosition = getStudyPosition(testExamCode);
          addToLog(`✅ Retrieved position: Question ${savedPosition ? savedPosition.questionNumber : 'None'}`, 'success');
          
          if (savedPosition) {
            addToLog(`📅 Saved on: ${new Date(savedPosition.timestamp).toLocaleString()}`, 'info');
            addToLog(`📊 Progress: ${savedPosition.questionNumber}/${savedPosition.totalQuestions}`, 'info');
          }

          // Test position validation
          addToLog("✅ Testing position validation", 'info');
          
          const isValid = validateSavedPosition(savedPosition, window.currentExam);
          addToLog(`✅ Position validation: ${isValid}`, isValid ? 'success' : 'error');

          // Test auto-save functionality
          addToLog("🤖 Testing auto-save", 'info');
          
          window.currentQuestionIndex = 8;
          const autoSaveResult = autoSavePosition();
          addToLog(`✅ Auto-save result: ${autoSaveResult}`, autoSaveResult ? 'success' : 'error');
          
          // Verify auto-save worked
          const autoSavedPosition = getStudyPosition(testExamCode);
          addToLog(`📍 Auto-saved position: Question ${autoSavedPosition ? autoSavedPosition.questionNumber : 'None'}`, 'info');

          // Test navigation change handling
          addToLog("🧭 Testing navigation change handling", 'info');
          
          handleNavigationChange(12);
          const navPosition = getStudyPosition(testExamCode);
          addToLog(`✅ Navigation change: Question ${navPosition ? navPosition.questionNumber : 'None'}`, 'success');

          // Test position cleaning
          addToLog("🧹 Testing position cleaning", 'info');
          
          // Create an old position for testing
          const oldPosition = {
            questionIndex: 3,
            timestamp: Date.now() - (35 * 24 * 60 * 60 * 1000), // 35 days old
            questionNumber: 4,
            totalQuestions: 20,
            examTitle: "Old Test"
          };
          
          const resumePositions = JSON.parse(localStorage.getItem("examViewerResumePositions") || "{}");
          resumePositions["OLD-EXAM"] = oldPosition;
          localStorage.setItem("examViewerResumePositions", JSON.stringify(resumePositions));
          
          const cleanedCount = cleanInvalidPositions();
          addToLog(`✅ Cleaned positions: ${cleanedCount} removed`, 'success');

          // Test resume dialog (without actually showing it)
          addToLog("💬 Testing resume dialog preparation", 'info');
          
          const currentPosition = getStudyPosition(testExamCode);
          if (currentPosition) {
            addToLog("✅ Resume dialog data ready", 'success');
            addToLog(`📋 Would show: "Continue from Question ${currentPosition.questionNumber}?"`, 'info');
          }

          // Test position resumption (mock)
          addToLog("▶️ Testing position resumption", 'info');
          
          if (currentPosition) {
            // Mock navigation function
            window.navigateToQuestionIndex = (index) => {
              window.currentQuestionIndex = index;
              addToLog(`🧭 Navigated to question ${index + 1}`, 'info');
            };
            
            const resumeResult = resumeToPosition(currentPosition);
            addToLog(`✅ Resume result: ${resumeResult}`, resumeResult ? 'success' : 'error');
            addToLog(`📍 Current position: Question ${window.currentQuestionIndex + 1}`, 'info');
          }

          // Test position clearing
          addToLog("🗑️ Testing position clearing", 'info');
          
          const clearResult = clearStudyPosition(testExamCode);
          addToLog(`✅ Clear result: ${clearResult}`, clearResult ? 'success' : 'error');
          
          const clearedPosition = getStudyPosition(testExamCode);
          addToLog(`📍 Position after clear: ${clearedPosition ? 'Still exists' : 'Cleared'}`, !clearedPosition ? 'success' : 'error');

          // Test with disabled feature
          addToLog("🚫 Testing with disabled feature", 'info');
          
          window.settings.enableResumePosition = false;
          const disabledSaveResult = saveStudyPosition(testExamCode, 10);
          addToLog(`✅ Save when disabled: ${disabledSaveResult}`, !disabledSaveResult ? 'success' : 'error');

          // Restore settings
          window.settings.enableResumePosition = true;

          // Test edge cases
          addToLog("⚠️ Testing edge cases", 'info');
          
          const invalidSave1 = saveStudyPosition("", 5);
          addToLog(`✅ Empty exam code: ${invalidSave1}`, !invalidSave1 ? 'success' : 'error');
          
          const invalidSave2 = saveStudyPosition(testExamCode, -1);
          addToLog(`✅ Negative index: ${invalidSave2}`, !invalidSave2 ? 'success' : 'error');
          
          const invalidSave3 = saveStudyPosition(testExamCode, 0);
          addToLog(`✅ Zero index (start): ${invalidSave3}`, !invalidSave3 ? 'success' : 'error');

          // Final summary
          addToLog("📊 Resume Position Module Test Summary", 'success');
          addToLog("✅ Position saving and retrieval", 'success');
          addToLog("✅ Auto-save functionality", 'success');
          addToLog("✅ Position validation and cleaning", 'success');
          addToLog("✅ Navigation change handling", 'success');
          addToLog("✅ Edge case handling", 'success');

        } catch (error) {
          addToLog(`❌ Resume Position test failed: ${error.message}`, 'error');
        }
      };

      window.clearTests = function() {
        document.getElementById('log-content').innerHTML = '';
        addToLog("🗑️ Test logs cleared", 'info');
        
        // Clear localStorage test data
        localStorage.removeItem('examViewerStatistics');
        localStorage.removeItem('examViewerFavorites');
        localStorage.removeItem('examViewerResumePositions');
        addToLog("🗑️ Test localStorage data cleared", 'info');
      };

      // Setup test event listeners
      document.getElementById('testStorage').addEventListener('click', testStorage);
      document.getElementById('testCompression').addEventListener('click', testCompression);
      document.getElementById('testSettings').addEventListener('click', testSettings);
      document.getElementById('testTheme').addEventListener('click', testTheme);
      document.getElementById('testModels').addEventListener('click', testModels);
      document.getElementById('testSession').addEventListener('click', testSession);
      document.getElementById('testUIEffects').addEventListener('click', testUIEffects);
      document.getElementById('testModals').addEventListener('click', testModals);
      document.getElementById('testStatistics').addEventListener('click', testStatistics);
      document.getElementById('testFavorites').addEventListener('click', testFavorites);
      document.getElementById('testSearch').addEventListener('click', testSearch);
      document.getElementById('testResume').addEventListener('click', testResume);
      document.getElementById('testMobile').addEventListener('click', testMobile);
      document.getElementById('testEnhanced').addEventListener('click', testEnhanced);
      document.getElementById('testDevMode').addEventListener('click', testDevMode);
      document.getElementById('clearTests').addEventListener('click', clearTests);
      
      // Setup settings test panel event listeners
      document.getElementById('saveSettingsTest').addEventListener('click', () => {
        saveSettingsUI();
        addToLog("💾 Settings manually saved from test panel", 'success');
      });
      
      document.getElementById('loadSettingsTest').addEventListener('click', () => {
        loadSettingsUI();
        addToLog("📂 Settings manually loaded from test panel", 'success');
      });

      addToLog("🚀 Modular test environment ready!", 'success');
      addToLog("Click buttons above to test Storage, Settings, Data Models & UI Effects modules functionality", 'info');
    </script>
  </body>
</html>